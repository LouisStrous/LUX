/** \file */

#include "PrutenicTables.h"
#include <assert.h>             /* for assert() */
#include <math.h>               /* for NAN */

/** Returns the value of a 2-position sexagesimal number.  This macro
    is a shorthand for sexagesimal2(). */
#define s60(a,b) ((a)+(b)/60.)

/** Returns the value of a 2-position sexagesimal number of which the
    first position indicates units.  */
#define sexagesimal2(c1,c2)          s60(c1,c2)

/** Returns the value of a 3-position sexagesimal number of which the
    first position indicates units.  */
#define sexagesimal3(c1,c2,c3)       s60(c1,s60(c2,c3))

/** Returns the value of a 4-position sexagesimal number of which the
    first position indicates units.  */
#define sexagesimal4(c1,c2,c3,c4)    s60(c1,s60(c2,s60(c3,c4)))

/** Returns the value of a 5-position sexagesimal number of which the
    first position indicates units.  */
#define sexagesimal5(c1,c2,c3,c4,c5) s60(c1,s60(c2,s60(c3,s60(c4,c5))))

/** Returns the value of a 7-position sexagesimal number of which the
    first position indicates units.  */
#define sexagesimal7(c1,c2,c3,c4,c5,c6,c7) \
  s60(c1,s60(c2,s60(c3,s60(c4,s60(c5,s60(c6,c7))))))

/** Returns the value of an 8-position sexagesimal number of which the
    first position indicates units.  */
#define sexagesimal8(c1,c2,c3,c4,c5,c6,c7,c8) \
  s60(c1,s60(c2,s60(c3,s60(c4,s60(c5,s60(c6,s60(c7,c8)))))))

/** Returns the quotient and non-negative remainder of a division.

    \param[in] x is the numerator or dividend.

    \param[in] y is the denominator or divisor.

    \returns the quotient and non-negative remainder of dividing \a x
    by \a y.  If \a y is 0, then returns `NAN`. */
struct fdiv_t pfdiv(double x, double y)
{
  struct fdiv_t result;
  if (y == 0) {
    result.quot = result.rem = NAN;
  } else {
    result.quot = floor(x/y);
    result.rem = x - y*result.quot;
  }
  return result;
}

/** Nonnegative modulus.

    \param[in] x is the numerator or dividend.

    \param[in] y is the denominator or divisor.

    \returns the nonnegative remainder of dividing \a x by \a y.  It
    is less in magnitude than \a y.  If \a y is 0, then returns `NAN`.
 */
double pmod(double x, double y)
{
  struct fdiv_t f = pfdiv(x, y);
  return f.rem;
}

/** Symmetric modulus.

    \param[in] x is the numerator or dividend.

    \param[in] y is the denominator or divisor.

    \returns the remainder of dividing \a x by \a y, between −|\a y/2|
    (exclusive) and +|\a y/2| (inclusive).  If \a y is 0, then returns
    `NAN`.
 */
double smod(double x, double y)
{
  struct fdiv_t f = pfdiv(x, y);
  if (f.rem > fabs(y)/2)
    f.rem -= fabs(y);
  return f.rem;
}

/** Linearly interpolate in a symmetrical table.

    \param[in] n is the number of elements in the array of
    \a values.  It must be greater than 0.

    \param[in] values points at the first element of the list of
    values.  It must not be `NULL`.

    \param[in] argument is the argument for which to find the value.

    \returns the interpolated value.

    Interpolates linearly in a symmetrical table.  \a values specifies
    the first half of the table, and ends with the element at the
    halfway point of the table.  The second half of the table is the
    reverse of the first half, but the halfway point is not
    duplicated.  The table is assumed to repeat itself indefinitely to
    earlier (including negative) and later arguments.  The period of
    the table (after which it repeats itself exactly) is 2×\a n − 2.
    The correspondence between arguments and values is schematically
    as follows:

    | Argument | Argument | Value       |
    |----------|----------|-------------|
    | 0        | 2×n − 2  | values[0]   |
    | 1        | 2×n − 3  | values[1]   |
    | ...      |          | ...         |
    | n − 3    | n + 1    | values[n−3] |
    | n − 2    | n        | values[n−2] |
    | n − 1    |          | values[n−1] |

    For example, if \a n = 3 then the period of the table is 4.

    | Argument | Value     |
    |----------|-----------|
    |       −2 | values[2] |
    |       −1 | values[1] |
    |        0 | values[0] |
    |        1 | values[1] |
    |        2 | values[2] |
    |        3 | values[1] |
    |        4 | values[0] |
    |        5 | values[1] |
    |        6 | values[2] |

 */
double interpolate_symmetric_linear(int n, double* values, double argument)
{
  assert(n > 0);
  assert(values != 0);
  argument = pmod(argument, 2*n - 2);
  if (argument > n - 1)
    argument = 2*n - 2 - argument;
  int int_argument = (int) argument;
  double bottom = values[int_argument];
  double top = values[int_argument + 1];
  double result = (top - bottom)*(argument - int_argument) + bottom;
  return result;
}

static double prutenic_centri_sol(double angle)
{
  static double centri[] =
    { sexagesimal3( 0,  0,  0 ),
      sexagesimal3( 0,  6, 50 ),
      sexagesimal3( 0, 13, 41 ),
      sexagesimal3( 0, 20, 31 ),
      sexagesimal3( 0, 27, 21 ),
      sexagesimal3( 0, 34, 10 ),
      sexagesimal3( 0, 41,  0 ),
      sexagesimal3( 0, 47, 48 ),
      sexagesimal3( 0, 54, 36 ),
      sexagesimal3( 1,  1, 23 ),
      sexagesimal3( 1,  8, 10 ),
      sexagesimal3( 1, 14, 56 ),
      sexagesimal3( 1, 21, 41 ),
      sexagesimal3( 1, 28, 24 ),
      sexagesimal3( 1, 35,  7 ),
      sexagesimal3( 1, 41, 49 ),
      sexagesimal3( 1, 48, 29 ),
      sexagesimal3( 1, 55,  7 ),
      sexagesimal3( 2,  1, 45 ),
      sexagesimal3( 2,  8, 21 ),
      sexagesimal3( 2, 14, 55 ),
      sexagesimal3( 2, 21, 27 ),
      sexagesimal3( 2, 27, 58 ),
      sexagesimal3( 2, 34, 27 ),
      sexagesimal3( 2, 40, 53 ),
      sexagesimal3( 2, 47, 18 ),
      sexagesimal3( 2, 53, 41 ),
      sexagesimal3( 3,  0,  1 ),
      sexagesimal3( 3,  6, 19 ),
      sexagesimal3( 3, 12, 34 ),
      sexagesimal3( 3, 18, 47 ),
      sexagesimal3( 3, 24, 58 ),
      sexagesimal3( 3, 31,  6 ),
      sexagesimal3( 3, 37, 11 ),
      sexagesimal3( 3, 43, 13 ),
      sexagesimal3( 3, 49, 12 ),
      sexagesimal3( 3, 55,  8 ),
      sexagesimal3( 4,  1,  1 ),
      sexagesimal3( 4,  6, 51 ),
      sexagesimal3( 4, 12, 38 ),
      sexagesimal3( 4, 18, 21 ),
      sexagesimal3( 4, 24,  1 ),
      sexagesimal3( 4, 29, 37 ),
      sexagesimal3( 4, 35, 10 ),
      sexagesimal3( 4, 40, 39 ),
      sexagesimal3( 4, 46,  4 ),
      sexagesimal3( 4, 51, 25 ),
      sexagesimal3( 4, 56, 42 ),
      sexagesimal3( 5,  1, 55 ),
      sexagesimal3( 5,  7,  4 ),
      sexagesimal3( 5, 12,  8 ),
      sexagesimal3( 5, 17,  8 ),
      sexagesimal3( 5, 22,  4 ),
      sexagesimal3( 5, 26, 55 ),
      sexagesimal3( 5, 31, 42 ),
      sexagesimal3( 5, 36, 24 ),
      sexagesimal3( 5, 41,  1 ),
      sexagesimal3( 5, 45, 33 ),
      sexagesimal3( 5, 50,  0 ),
      sexagesimal3( 5, 54, 22 ),
      sexagesimal3( 5, 58, 39 ),
      sexagesimal3( 6,  2, 51 ),
      sexagesimal3( 6,  6, 57 ),
      sexagesimal3( 6, 10, 58 ),
      sexagesimal3( 6, 14, 53 ),
      sexagesimal3( 6, 18, 43 ),
      sexagesimal3( 6, 22, 27 ),
      sexagesimal3( 6, 26,  5 ),
      sexagesimal3( 6, 29, 38 ),
      sexagesimal3( 6, 33,  4 ),
      sexagesimal3( 6, 36, 25 ),
      sexagesimal3( 6, 39, 39 ),
      sexagesimal3( 6, 42, 47 ),
      sexagesimal3( 6, 45, 49 ),
      sexagesimal3( 6, 48, 44 ),
      sexagesimal3( 6, 51, 33 ),
      sexagesimal3( 6, 54, 16 ),
      sexagesimal3( 6, 56, 52 ),
      sexagesimal3( 6, 59, 21 ),
      sexagesimal3( 7,  1, 43 ),
      sexagesimal3( 7,  3, 59 ),
      sexagesimal3( 7,  6,  7 ),
      sexagesimal3( 7,  8,  9 ),
      sexagesimal3( 7, 10,  3 ),
      sexagesimal3( 7, 11, 50 ),
      sexagesimal3( 7, 13, 30 ),
      sexagesimal3( 7, 15,  2 ),
      sexagesimal3( 7, 16, 28 ),
      sexagesimal3( 7, 17, 45 ),
      sexagesimal3( 7, 18, 55 ),
      sexagesimal3( 7, 19, 58 ),
      sexagesimal3( 7, 20, 53 ),
      sexagesimal3( 7, 21, 40 ),
      sexagesimal3( 7, 22, 19 ),
      sexagesimal3( 7, 22, 50 ),
      sexagesimal3( 7, 23, 13 ),
      sexagesimal3( 7, 23, 29 ),
      sexagesimal3( 7, 23, 36 ),
      sexagesimal3( 7, 23, 35 ),
      sexagesimal3( 7, 23, 26 ),
      sexagesimal3( 7, 23,  9 ),
      sexagesimal3( 7, 22, 43 ),
      sexagesimal3( 7, 22, 10 ),
      sexagesimal3( 7, 21, 27 ),
      sexagesimal3( 7, 20, 36 ),
      sexagesimal3( 7, 19, 37 ),
      sexagesimal3( 7, 18, 29 ),
      sexagesimal3( 7, 17, 13 ),
      sexagesimal3( 7, 15, 48 ),
      sexagesimal3( 7, 14, 15 ),
      sexagesimal3( 7, 12, 33 ),
      sexagesimal3( 7, 10, 42 ),
      sexagesimal3( 7,  8, 42 ),
      sexagesimal3( 7,  6, 34 ),
      sexagesimal3( 7,  4, 17 ),
      sexagesimal3( 7,  1, 52 ),
      sexagesimal3( 6, 59, 17 ),
      sexagesimal3( 6, 56, 34 ),
      sexagesimal3( 6, 53, 42 ),
      sexagesimal3( 6, 50, 42 ),
      sexagesimal3( 6, 47, 32 ),
      sexagesimal3( 6, 44, 14 ),
      sexagesimal3( 6, 40, 47 ),
      sexagesimal3( 6, 37, 12 ),
      sexagesimal3( 6, 33, 28 ),
      sexagesimal3( 6, 29, 35 ),
      sexagesimal3( 6, 25, 33 ),
      sexagesimal3( 6, 21, 23 ),
      sexagesimal3( 6, 17,  5 ),
      sexagesimal3( 6, 12, 38 ),
      sexagesimal3( 6,  8,  2 ),
      sexagesimal3( 6,  3, 18 ),
      sexagesimal3( 5, 58, 26 ),
      sexagesimal3( 5, 53, 25 ),
      sexagesimal3( 5, 48, 16 ),
      sexagesimal3( 5, 42, 59 ),
      sexagesimal3( 5, 37, 34 ),
      sexagesimal3( 5, 32,  1 ),
      sexagesimal3( 5, 26, 20 ),
      sexagesimal3( 5, 20, 31 ),
      sexagesimal3( 5, 14, 34 ),
      sexagesimal3( 5,  8, 30 ),
      sexagesimal3( 5,  2, 19 ),
      sexagesimal3( 4, 56,  0 ),
      sexagesimal3( 4, 49, 33 ),
      sexagesimal3( 4, 43,  0 ),
      sexagesimal3( 4, 36, 19 ),
      sexagesimal3( 4, 29, 32 ),
      sexagesimal3( 4, 22, 38 ),
      sexagesimal3( 4, 15, 37 ),
      sexagesimal3( 4,  8, 30 ),
      sexagesimal3( 4,  1, 16 ),
      sexagesimal3( 3, 53, 57 ),
      sexagesimal3( 3, 46, 31 ),
      sexagesimal3( 3, 39,  0 ),
      sexagesimal3( 3, 31, 23 ),
      sexagesimal3( 3, 23, 40 ),
      sexagesimal3( 3, 15, 52 ),
      sexagesimal3( 3,  7, 59 ),
      sexagesimal3( 3,  0,  1 ),
      sexagesimal3( 2, 51, 59 ),
      sexagesimal3( 2, 43, 51 ),
      sexagesimal3( 2, 35, 40 ),
      sexagesimal3( 2, 27, 24 ),
      sexagesimal3( 2, 19,  4 ),
      sexagesimal3( 2, 10, 41 ),
      sexagesimal3( 2,  2, 14 ),
      sexagesimal3( 1, 53, 44 ),
      sexagesimal3( 1, 45, 11 ),
      sexagesimal3( 1, 36, 35 ),
      sexagesimal3( 1, 27, 57 ),
      sexagesimal3( 1, 19, 16 ),
      sexagesimal3( 1, 10, 33 ),
      sexagesimal3( 1,  1, 48 ),
      sexagesimal3( 0, 53,  1 ),
      sexagesimal3( 0, 44, 13 ),
      sexagesimal3( 0, 35, 24 ),
      sexagesimal3( 0, 26, 34 ),
      sexagesimal3( 0, 17, 43 ),
      sexagesimal3( 0,  8, 52 ),
      sexagesimal3( 0,  0,  0 ),
    };
  return interpolate_symmetric_linear(sizeof(centri)/sizeof(*centri),
                                      centri, angle);
}

static double prutenic_orbis_sol(double angle)
{
  double orbis[] =
    {
     sexagesimal3(0,  0,  0),
     sexagesimal3(0,  1, 52),
     sexagesimal3(0,  3, 45),
     sexagesimal3(0,  5, 37),
     sexagesimal3(0,  7, 29),
     sexagesimal3(0,  9, 21),
     sexagesimal3(0, 11, 13),
     sexagesimal3(0, 13,  4),
     sexagesimal3(0, 14, 56),
     sexagesimal3(0, 16, 47),
     sexagesimal3(0, 18, 38),
     sexagesimal3(0, 20, 28),
     sexagesimal3(0, 22, 18),
     sexagesimal3(0, 24,  8),
     sexagesimal3(0, 25, 58),
     sexagesimal3(0, 27, 47),
     sexagesimal3(0, 29, 35),
     sexagesimal3(0, 31, 23),
     sexagesimal3(0, 33, 11),
     sexagesimal3(0, 34, 58),
     sexagesimal3(0, 36, 44),
     sexagesimal3(0, 38, 30),
     sexagesimal3(0, 40, 15),
     sexagesimal3(0, 42,  0),
     sexagesimal3(0, 43, 43),
     sexagesimal3(0, 45, 26),
     sexagesimal3(0, 47,  9),
     sexagesimal3(0, 48, 50),
     sexagesimal3(0, 50, 31),
     sexagesimal3(0, 52, 11),
     sexagesimal3(0, 53, 50),
     sexagesimal3(0, 55, 28),
     sexagesimal3(0, 57,  5),
     sexagesimal3(0, 58, 41),
     sexagesimal3(1,  0, 16),
     sexagesimal3(1,  1, 50),
     sexagesimal3(1,  3, 23),
     sexagesimal3(1,  4, 55),
     sexagesimal3(1,  6, 26),
     sexagesimal3(1,  7, 56),
     sexagesimal3(1,  9, 25),
     sexagesimal3(1, 10, 52),
     sexagesimal3(1, 12, 19),
     sexagesimal3(1, 13, 44),
     sexagesimal3(1, 15,  7),
     sexagesimal3(1, 16, 30),
     sexagesimal3(1, 17, 51),
     sexagesimal3(1, 19, 11),
     sexagesimal3(1, 20, 30),
     sexagesimal3(1, 21, 47),
     sexagesimal3(1, 23,  2),
     sexagesimal3(1, 24, 17),
     sexagesimal3(1, 25, 30),
     sexagesimal3(1, 26, 41),
     sexagesimal3(1, 27, 51),
     sexagesimal3(1, 28, 59),
     sexagesimal3(1, 30,  6),
     sexagesimal3(1, 31, 11),
     sexagesimal3(1, 32, 15),
     sexagesimal3(1, 33, 17),
     sexagesimal3(1, 34, 18),
     sexagesimal3(1, 35, 17),
     sexagesimal3(1, 36, 14),
     sexagesimal3(1, 37,  9),
     sexagesimal3(1, 38,  3),
     sexagesimal3(1, 38, 55),
     sexagesimal3(1, 39, 46),
     sexagesimal3(1, 40, 34),
     sexagesimal3(1, 41, 21),
     sexagesimal3(1, 42,  6),
     sexagesimal3(1, 42, 50),
     sexagesimal3(1, 43, 31),
     sexagesimal3(1, 44, 11),
     sexagesimal3(1, 44, 49),
     sexagesimal3(1, 45, 25),
     sexagesimal3(1, 45, 59),
     sexagesimal3(1, 46, 31),
     sexagesimal3(1, 47,  1),
     sexagesimal3(1, 47, 30),
     sexagesimal3(1, 47, 56),
     sexagesimal3(1, 48, 21),
     sexagesimal3(1, 48, 43),
     sexagesimal3(1, 49,  4),
     sexagesimal3(1, 49, 22),
     sexagesimal3(1, 49, 39),
     sexagesimal3(1, 49, 54),
     sexagesimal3(1, 50,  7),
     sexagesimal3(1, 50, 17),
     sexagesimal3(1, 50, 26),
     sexagesimal3(1, 50, 33),
     sexagesimal3(1, 50, 38),
     sexagesimal3(1, 50, 40),
     sexagesimal3(1, 50, 41),
     sexagesimal3(1, 50, 40),
     sexagesimal3(1, 50, 36),
     sexagesimal3(1, 50, 31),
     sexagesimal3(1, 50, 24),
     sexagesimal3(1, 50, 14),
     sexagesimal3(1, 50,  3),
     sexagesimal3(1, 49, 49),
     sexagesimal3(1, 49, 34),
     sexagesimal3(1, 49, 16),
     sexagesimal3(1, 48, 56),
     sexagesimal3(1, 48, 35),
     sexagesimal3(1, 48, 11),
     sexagesimal3(1, 47, 45),
     sexagesimal3(1, 47, 18),
     sexagesimal3(1, 46, 48),
     sexagesimal3(1, 46, 16),
     sexagesimal3(1, 45, 43),
     sexagesimal3(1, 45,  7),
     sexagesimal3(1, 44, 29),
     sexagesimal3(1, 43, 50),
     sexagesimal3(1, 43,  8),
     sexagesimal3(1, 42, 25),
     sexagesimal3(1, 41, 39),
     sexagesimal3(1, 40, 52),
     sexagesimal3(1, 40,  2),
     sexagesimal3(1, 39, 11),
     sexagesimal3(1, 38, 18),
     sexagesimal3(1, 37, 23),
     sexagesimal3(1, 36, 26),
     sexagesimal3(1, 35, 27),
     sexagesimal3(1, 34, 27),
     sexagesimal3(1, 33, 24),
     sexagesimal3(1, 32, 20),
     sexagesimal3(1, 31, 14),
     sexagesimal3(1, 30,  6),
     sexagesimal3(1, 28, 57),
     sexagesimal3(1, 27, 46),
     sexagesimal3(1, 26, 33),
     sexagesimal3(1, 25, 18),
     sexagesimal3(1, 24,  2),
     sexagesimal3(1, 22, 44),
     sexagesimal3(1, 21, 25),
     sexagesimal3(1, 20,  4),
     sexagesimal3(1, 18, 41),
     sexagesimal3(1, 17, 17),
     sexagesimal3(1, 15, 51),
     sexagesimal3(1, 14, 24),
     sexagesimal3(1, 12, 55),
     sexagesimal3(1, 11, 25),
     sexagesimal3(1,  9, 54),
     sexagesimal3(1,  8, 21),
     sexagesimal3(1,  6, 47),
     sexagesimal3(1,  5, 11),
     sexagesimal3(1,  3, 34),
     sexagesimal3(1,  1, 56),
     sexagesimal3(1,  0, 17),
     sexagesimal3(0, 58, 37),
     sexagesimal3(0, 56, 55),
     sexagesimal3(0, 55, 12),
     sexagesimal3(0, 53, 28),
     sexagesimal3(0, 51, 43),
     sexagesimal3(0, 49, 57),
     sexagesimal3(0, 48, 10),
     sexagesimal3(0, 46, 22),
     sexagesimal3(0, 44, 34),
     sexagesimal3(0, 42, 44),
     sexagesimal3(0, 40, 53),
     sexagesimal3(0, 39,  2),
     sexagesimal3(0, 37, 10),
     sexagesimal3(0, 35, 17),
     sexagesimal3(0, 33, 23),
     sexagesimal3(0, 31, 29),
     sexagesimal3(0, 29, 34),
     sexagesimal3(0, 27, 38),
     sexagesimal3(0, 25, 42),
     sexagesimal3(0, 23, 45),
     sexagesimal3(0, 21, 48),
     sexagesimal3(0, 19, 51),
     sexagesimal3(0, 17, 53),
     sexagesimal3(0, 15, 55),
     sexagesimal3(0, 13, 56),
     sexagesimal3(0, 11, 57),
     sexagesimal3(0,  9, 58),
     sexagesimal3(0,  7, 59),
     sexagesimal3(0,  5, 59),
     sexagesimal3(0,  3, 59),
     sexagesimal3(0,  2,  0),
     sexagesimal3(0,  0,  0),
    };
  return interpolate_symmetric_linear(sizeof(orbis)/sizeof(*orbis),
                                      orbis, angle);
}

static double prutenic_excess_sol(double angle)
{
  double excess[] =
    {
     sexagesimal2( 0,  0),
     sexagesimal2( 0, 32),
     sexagesimal2( 1,  4),
     sexagesimal2( 1, 36),
     sexagesimal2( 2,  7),
     sexagesimal2( 2, 39),
     sexagesimal2( 3, 11),
     sexagesimal2( 3, 42),
     sexagesimal2( 4, 14),
     sexagesimal2( 4, 46),
     sexagesimal2( 5, 17),
     sexagesimal2( 5, 48),
     sexagesimal2( 6, 20),
     sexagesimal2( 6, 51),
     sexagesimal2( 7, 22),
     sexagesimal2( 7, 53),
     sexagesimal2( 8, 24),
     sexagesimal2( 8, 55),
     sexagesimal2( 9, 26),
     sexagesimal2( 9, 56),
     sexagesimal2(10, 26),
     sexagesimal2(10, 57),
     sexagesimal2(11, 27),
     sexagesimal2(11, 57),
     sexagesimal2(12, 26),
     sexagesimal2(12, 56),
     sexagesimal2(13, 25),
     sexagesimal2(13, 54),
     sexagesimal2(14, 23),
     sexagesimal2(14, 52),
     sexagesimal2(15, 20),
     sexagesimal2(15, 49),
     sexagesimal2(16, 17),
     sexagesimal2(16, 45),
     sexagesimal2(17, 12),
     sexagesimal2(17, 39),
     sexagesimal2(18,  6),
     sexagesimal2(18, 33),
     sexagesimal2(19,  0),
     sexagesimal2(19, 26),
     sexagesimal2(19, 52),
     sexagesimal2(20, 17),
     sexagesimal2(20, 42),
     sexagesimal2(21,  7),
     sexagesimal2(21, 32),
     sexagesimal2(21, 56),
     sexagesimal2(22, 20),
     sexagesimal2(22, 44),
     sexagesimal2(23,  7),
     sexagesimal2(23, 30),
     sexagesimal2(23, 52),
     sexagesimal2(24, 15),
     sexagesimal2(24, 36),
     sexagesimal2(24, 58),
     sexagesimal2(25, 19),
     sexagesimal2(25, 39),
     sexagesimal2(25, 59),
     sexagesimal2(26, 19),
     sexagesimal2(26, 39),
     sexagesimal2(26, 57),
     sexagesimal2(27, 16),
     sexagesimal2(27, 34),
     sexagesimal2(27, 52),
     sexagesimal2(28,  9),
     sexagesimal2(28, 25),
     sexagesimal2(28, 41),
     sexagesimal2(28, 57),
     sexagesimal2(29, 12),
     sexagesimal2(29, 27),
     sexagesimal2(29, 41),
     sexagesimal2(29, 55),
     sexagesimal2(30,  8),
     sexagesimal2(30, 21),
     sexagesimal2(30, 33),
     sexagesimal2(30, 45),
     sexagesimal2(30, 56),
     sexagesimal2(31,  7),
     sexagesimal2(31, 17),
     sexagesimal2(31, 27),
     sexagesimal2(31, 36),
     sexagesimal2(31, 44),
     sexagesimal2(31, 52),
     sexagesimal2(32,  0),
     sexagesimal2(32,  7),
     sexagesimal2(32, 13),
     sexagesimal2(32, 19),
     sexagesimal2(32, 24),
     sexagesimal2(32, 28),
     sexagesimal2(32, 32),
     sexagesimal2(32, 36),
     sexagesimal2(32, 39),
     sexagesimal2(32, 41),
     sexagesimal2(32, 43),
     sexagesimal2(32, 44),
     sexagesimal2(32, 44),
     sexagesimal2(32, 44),
     sexagesimal2(32, 43),
     sexagesimal2(32, 42),
     sexagesimal2(32, 40),
     sexagesimal2(32, 37),
     sexagesimal2(32, 34),
     sexagesimal2(32, 30),
     sexagesimal2(32, 26),
     sexagesimal2(32, 21),
     sexagesimal2(32, 15),
     sexagesimal2(32,  9),
     sexagesimal2(32,  2),
     sexagesimal2(31, 54),
     sexagesimal2(31, 46),
     sexagesimal2(31, 38),
     sexagesimal2(31, 28),
     sexagesimal2(31, 18),
     sexagesimal2(31,  8),
     sexagesimal2(30, 56),
     sexagesimal2(30, 45),
     sexagesimal2(30, 32),
     sexagesimal2(30, 19),
     sexagesimal2(30,  6),
     sexagesimal2(29, 51),
     sexagesimal2(29, 37),
     sexagesimal2(29, 21),
     sexagesimal2(29,  5),
     sexagesimal2(28, 49),
     sexagesimal2(28, 31),
     sexagesimal2(28, 14),
     sexagesimal2(27, 55),
     sexagesimal2(27, 36),
     sexagesimal2(27, 17),
     sexagesimal2(26, 57),
     sexagesimal2(26, 36),
     sexagesimal2(26, 15),
     sexagesimal2(25, 53),
     sexagesimal2(25, 31),
     sexagesimal2(25,  8),
     sexagesimal2(24, 45),
     sexagesimal2(24, 21),
     sexagesimal2(23, 57),
     sexagesimal2(23, 32),
     sexagesimal2(23,  7),
     sexagesimal2(22, 41),
     sexagesimal2(22, 14),
     sexagesimal2(21, 48),
     sexagesimal2(21, 20),
     sexagesimal2(20, 53),
     sexagesimal2(20, 24),
     sexagesimal2(19, 56),
     sexagesimal2(19, 27),
     sexagesimal2(18, 57),
     sexagesimal2(18, 27),
     sexagesimal2(17, 57),
     sexagesimal2(17, 26),
     sexagesimal2(16, 55),
     sexagesimal2(16, 24),
     sexagesimal2(15, 52),
     sexagesimal2(15, 20),
     sexagesimal2(14, 47),
     sexagesimal2(14, 14),
     sexagesimal2(13, 41),
     sexagesimal2(13,  8),
     sexagesimal2(12, 34),
     sexagesimal2(12,  0),
     sexagesimal2(11, 26),
     sexagesimal2(10, 51),
     sexagesimal2(10, 16),
     sexagesimal2( 9, 41),
     sexagesimal2( 9,  6),
     sexagesimal2( 8, 30),
     sexagesimal2( 7, 55),
     sexagesimal2( 7, 19),
     sexagesimal2( 6, 43),
     sexagesimal2( 6,  7),
     sexagesimal2( 5, 30),
     sexagesimal2( 4, 54),
     sexagesimal2( 4, 18),
     sexagesimal2( 3, 41),
     sexagesimal2( 3,  4),
     sexagesimal2( 2, 28),
     sexagesimal2( 1, 51),
     sexagesimal2( 1, 14),
     sexagesimal2( 0, 37),
     sexagesimal2( 0,  0),
    };
  return interpolate_symmetric_linear(sizeof(excess)/sizeof(*excess),
                                      excess, angle)/60.;
}

static double prutenic_prop_sol(double angle)
{
  double prop[] =
    {
     sexagesimal2(60,  0),
     sexagesimal2(60,  0),
     sexagesimal2(59, 59),
     sexagesimal2(59, 58),
     sexagesimal2(59, 56),
     sexagesimal2(59, 54),
     sexagesimal2(59, 51),
     sexagesimal2(59, 48),
     sexagesimal2(59, 44),
     sexagesimal2(59, 40),
     sexagesimal2(59, 36),
     sexagesimal2(59, 30),
     sexagesimal2(59, 25),
     sexagesimal2(59, 19),
     sexagesimal2(59, 12),
     sexagesimal2(59,  5),
     sexagesimal2(58, 58),
     sexagesimal2(58, 50),
     sexagesimal2(58, 42),
     sexagesimal2(58, 33),
     sexagesimal2(58, 23),
     sexagesimal2(58, 14),
     sexagesimal2(58,  3),
     sexagesimal2(57, 53),
     sexagesimal2(57, 41),
     sexagesimal2(57, 30),
     sexagesimal2(57, 18),
     sexagesimal2(57,  5),
     sexagesimal2(56, 52),
     sexagesimal2(56, 39),
     sexagesimal2(56, 25),
     sexagesimal2(56, 10),
     sexagesimal2(55, 56),
     sexagesimal2(55, 41),
     sexagesimal2(55, 25),
     sexagesimal2(55,  9),
     sexagesimal2(54, 52),
     sexagesimal2(54, 35),
     sexagesimal2(54, 18),
     sexagesimal2(54,  0),
     sexagesimal2(53, 42),
     sexagesimal2(53, 24),
     sexagesimal2(53,  5),
     sexagesimal2(52, 46),
     sexagesimal2(52, 26),
     sexagesimal2(52,  6),
     sexagesimal2(51, 45),
     sexagesimal2(51, 24),
     sexagesimal2(51,  3),
     sexagesimal2(50, 42),
     sexagesimal2(50, 20),
     sexagesimal2(49, 57),
     sexagesimal2(49, 35),
     sexagesimal2(49, 12),
     sexagesimal2(48, 48),
     sexagesimal2(48, 24),
     sexagesimal2(48,  0),
     sexagesimal2(47, 36),
     sexagesimal2(47, 12),
     sexagesimal2(46, 47),
     sexagesimal2(46, 21),
     sexagesimal2(45, 56),
     sexagesimal2(45, 30),
     sexagesimal2(45,  4),
     sexagesimal2(44, 37),
     sexagesimal2(44, 11),
     sexagesimal2(43, 44),
     sexagesimal2(43, 16),
     sexagesimal2(42, 49),
     sexagesimal2(42, 21),
     sexagesimal2(41, 53),
     sexagesimal2(41, 25),
     sexagesimal2(40, 57),
     sexagesimal2(40, 28),
     sexagesimal2(39, 59),
     sexagesimal2(39, 30),
     sexagesimal2(39,  1),
     sexagesimal2(38, 31),
     sexagesimal2(38,  2),
     sexagesimal2(37, 32),
     sexagesimal2(37,  2),
     sexagesimal2(36, 32),
     sexagesimal2(36,  2),
     sexagesimal2(35, 31),
     sexagesimal2(35,  1),
     sexagesimal2(34, 30),
     sexagesimal2(33, 59),
     sexagesimal2(33, 28),
     sexagesimal2(32, 57),
     sexagesimal2(32, 26),
     sexagesimal2(31, 55),
     sexagesimal2(31, 24),
     sexagesimal2(30, 53),
     sexagesimal2(30, 21),
     sexagesimal2(29, 50),
     sexagesimal2(29, 19),
     sexagesimal2(28, 47),
     sexagesimal2(28, 16),
     sexagesimal2(27, 45),
     sexagesimal2(27, 13),
     sexagesimal2(26, 42),
     sexagesimal2(26, 10),
     sexagesimal2(25, 39),
     sexagesimal2(25,  8),
     sexagesimal2(24, 36),
     sexagesimal2(24,  5),
     sexagesimal2(23, 34),
     sexagesimal2(23,  3),
     sexagesimal2(22, 32),
     sexagesimal2(22,  1),
     sexagesimal2(21, 31),
     sexagesimal2(21,  0),
     sexagesimal2(20, 30),
     sexagesimal2(19, 59),
     sexagesimal2(19, 29),
     sexagesimal2(18, 59),
     sexagesimal2(18, 30),
     sexagesimal2(18,  0),
     sexagesimal2(17, 31),
     sexagesimal2(17,  1),
     sexagesimal2(16, 32),
     sexagesimal2(16,  4),
     sexagesimal2(15, 35),
     sexagesimal2(15,  7),
     sexagesimal2(14, 39),
     sexagesimal2(14, 11),
     sexagesimal2(13, 44),
     sexagesimal2(13, 16),
     sexagesimal2(12, 50),
     sexagesimal2(12, 23),
     sexagesimal2(11, 57),
     sexagesimal2(11, 31),
     sexagesimal2(11,  5),
     sexagesimal2(10, 40),
     sexagesimal2(10, 15),
     sexagesimal2( 9, 51),
     sexagesimal2( 9, 27),
     sexagesimal2( 9,  3),
     sexagesimal2( 8, 39),
     sexagesimal2( 8, 17),
     sexagesimal2( 7, 54),
     sexagesimal2( 7, 32),
     sexagesimal2( 7, 10),
     sexagesimal2( 6, 49),
     sexagesimal2( 6, 28),
     sexagesimal2( 6,  8),
     sexagesimal2( 5, 48),
     sexagesimal2( 5, 29),
     sexagesimal2( 5, 10),
     sexagesimal2( 4, 52),
     sexagesimal2( 4, 34),
     sexagesimal2( 4, 16),
     sexagesimal2( 3, 59),
     sexagesimal2( 3, 43),
     sexagesimal2( 3, 27),
     sexagesimal2( 3, 12),
     sexagesimal2( 2, 57),
     sexagesimal2( 2, 43),
     sexagesimal2( 2, 29),
     sexagesimal2( 2, 16),
     sexagesimal2( 2,  4),
     sexagesimal2( 1, 52),
     sexagesimal2( 1, 41),
     sexagesimal2( 1, 30),
     sexagesimal2( 1, 20),
     sexagesimal2( 1, 10),
     sexagesimal2( 1,  1),
     sexagesimal2( 0, 53),
     sexagesimal2( 0, 45),
     sexagesimal2( 0, 38),
     sexagesimal2( 0, 31),
     sexagesimal2( 0, 25),
     sexagesimal2( 0, 20),
     sexagesimal2( 0, 15),
     sexagesimal2( 0, 11),
     sexagesimal2( 0,  8),
     sexagesimal2( 0,  5),
     sexagesimal2( 0,  3),
     sexagesimal2( 0,  1),
     sexagesimal2( 0,  0),
     sexagesimal2( 0,  0),
    };
  return interpolate_symmetric_linear(sizeof(prop)/sizeof(*prop),
                                      prop, angle);
}

double prutenic_mean_longitude_sol(double days_since_epoch)
{
  static double simplex_radix = sexagesimal5(272, 29, 51, 32, 55);
  static double simplex_daily = sexagesimal7(359, 44, 49, 10, 28, 28, 24)/365;

  double mean_longitude = pmod(simplex_radix + days_since_epoch*simplex_daily, 360);
  return mean_longitude;
}

double prutenic_first_anomaly_sol(double days_since_epoch)
{
  static double first_anomaly_radix = sexagesimal5(6, 40, 27, 28,  6);
  static double first_anomaly_daily = sexagesimal7(0,  6, 17, 24,  8, 48, 22)/365;
  double first_anomaly = pmod(first_anomaly_radix
                              + days_since_epoch*first_anomaly_daily, 360);
  return first_anomaly;
}

double prutenic_precession(double days_since_epoch)
{
  static double precession_radix = sexagesimal5(5, 32, 24,  6, 59);
  static double precession_daily = sexagesimal7(0,  0, 50, 12,  5,  7, 54)/365;

  static double equation_amplitude = sexagesimal4(1, 11, 22, 30);

  double first_anomaly = prutenic_first_anomaly_sol(days_since_epoch);
  double mean_precession = pmod(precession_radix
                                + days_since_epoch*precession_daily, 360);
  double precession_equation
    = -equation_amplitude*sin(2*first_anomaly*M_PI/180.0);
  double true_precession = mean_precession + precession_equation;
  return true_precession;
}

/** Calculate the solar ecliptic longitude.

    \param[in] days_since_epoch is the number of days since the epoch.

    \returns the solar ecliptic longitude (relative to a fixed
    equinox) in degrees.
 */
double prutenic_longitude_sol(double days_since_epoch)
{
  static double anomaly_radix = sexagesimal5(211, 39,  2, 20, 49);
  static double anomaly_daily = sexagesimal7(359, 44, 23, 37, 16, 35, 59)/365;

  double mean_longitude = prutenic_mean_longitude_sol(days_since_epoch);
  double mean_anomaly = pmod(anomaly_radix + days_since_epoch*anomaly_daily, 360);

  double first_anomaly = prutenic_first_anomaly_sol(days_since_epoch);

  double prop = prutenic_prop_sol(first_anomaly);
  double precession = prutenic_precession(days_since_epoch);
  double corrected_anomaly = mean_anomaly + prutenic_centri_sol(first_anomaly);
  double orbis = prutenic_orbis_sol(corrected_anomaly);
  double excess = prutenic_excess_sol(corrected_anomaly);
  double equation = orbis + prop/60*excess;

  double true_longitude_1st_aries = pmod((mean_anomaly < 180)?
                                         mean_longitude - equation:
                                         mean_longitude + equation, 360);
  double true_longitude = true_longitude_1st_aries + precession;
  return true_longitude;
}

double prutenic_2nd_epicycle_luna(double angle)
{
  double table[] =
    {
     sexagesimal3( 0,  0,  0),
     sexagesimal3( 0, 16, 29),
     sexagesimal3( 0, 32, 58),
     sexagesimal3( 0, 49, 25),
     sexagesimal3( 1,  5, 51),
     sexagesimal3( 1, 22, 14),
     sexagesimal3( 1, 38, 35),
     sexagesimal3( 1, 54, 52),
     sexagesimal3( 2, 11,  4),
     sexagesimal3( 2, 27, 12),
     sexagesimal3( 2, 43, 15),
     sexagesimal3( 2, 59, 12),
     sexagesimal3( 3, 15,  3),
     sexagesimal3( 3, 30, 47),
     sexagesimal3( 3, 46, 23),
     sexagesimal3( 4,  1, 51),
     sexagesimal3( 4, 17, 11),
     sexagesimal3( 4, 32, 23),
     sexagesimal3( 4, 47, 24),
     sexagesimal3( 5,  2, 16),
     sexagesimal3( 5, 16, 58),
     sexagesimal3( 5, 31, 29),
     sexagesimal3( 5, 45, 48),
     sexagesimal3( 5, 59, 56),
     sexagesimal3( 6, 13, 53),
     sexagesimal3( 6, 27, 36),
     sexagesimal3( 6, 41,  7),
     sexagesimal3( 6, 54, 26),
     sexagesimal3( 7,  7, 30),
     sexagesimal3( 7, 20, 21),
     sexagesimal3( 7, 32, 58),
     sexagesimal3( 7, 45, 21),
     sexagesimal3( 7, 57, 29),
     sexagesimal3( 8,  9, 23),
     sexagesimal3( 8, 21,  2),
     sexagesimal3( 8, 32, 25),
     sexagesimal3( 8, 43, 33),
     sexagesimal3( 8, 54, 25),
     sexagesimal3( 9,  5,  2),
     sexagesimal3( 9, 15, 22),
     sexagesimal3( 9, 25, 27),
     sexagesimal3( 9, 35, 15),
     sexagesimal3( 9, 44, 47),
     sexagesimal3( 9, 54,  3),
     sexagesimal3(10,  3,  2),
     sexagesimal3(10, 11, 45),
     sexagesimal3(10, 20, 11),
     sexagesimal3(10, 28, 20),
     sexagesimal3(10, 36, 13),
     sexagesimal3(10, 43, 49),
     sexagesimal3(10, 51,  9),
     sexagesimal3(10, 58, 11),
     sexagesimal3(11,  4, 57),
     sexagesimal3(11, 11, 26),
     sexagesimal3(11, 17, 39),
     sexagesimal3(11, 23, 35),
     sexagesimal3(11, 29, 14),
     sexagesimal3(11, 34, 37),
     sexagesimal3(11, 39, 43),
     sexagesimal3(11, 44, 34),
     sexagesimal3(11, 49,  7),
     sexagesimal3(11, 53, 25),
     sexagesimal3(11, 57, 26),
     sexagesimal3(12,  1, 12),
     sexagesimal3(12,  4, 41),
     sexagesimal3(12,  7, 55),
     sexagesimal3(12, 10, 53),
     sexagesimal3(12, 13, 36),
     sexagesimal3(12, 16,  3),
     sexagesimal3(12, 18, 15),
     sexagesimal3(12, 20, 11),
     sexagesimal3(12, 21, 53),
     sexagesimal3(12, 23, 20),
     sexagesimal3(12, 24, 32),
     sexagesimal3(12, 25, 30),
     sexagesimal3(12, 26, 13),
     sexagesimal3(12, 26, 41),
     sexagesimal3(12, 26, 56),
     sexagesimal3(12, 26, 57),
     sexagesimal3(12, 26, 44),
     sexagesimal3(12, 26, 17),
     sexagesimal3(12, 25, 37),
     sexagesimal3(12, 24, 43),
     sexagesimal3(12, 23, 36),
     sexagesimal3(12, 22, 17),
     sexagesimal3(12, 20, 44),
     sexagesimal3(12, 18, 59),
     sexagesimal3(12, 17,  2),
     sexagesimal3(12, 14, 52),
     sexagesimal3(12, 12, 30),
     sexagesimal3(12,  9, 56),
     sexagesimal3(12,  7, 10),
     sexagesimal3(12,  4, 13),
     sexagesimal3(12,  1,  4),
     sexagesimal3(11, 57, 44),
     sexagesimal3(11, 54, 13),
     sexagesimal3(11, 50, 31),
     sexagesimal3(11, 46, 38),
     sexagesimal3(11, 42, 34),
     sexagesimal3(11, 38, 20),
     sexagesimal3(11, 33, 56),
     sexagesimal3(11, 29, 21),
     sexagesimal3(11, 24, 37),
     sexagesimal3(11, 19, 43),
     sexagesimal3(11, 14, 39),
     sexagesimal3(11,  9, 26),
     sexagesimal3(11,  4,  3),
     sexagesimal3(10, 58, 32),
     sexagesimal3(10, 52, 51),
     sexagesimal3(10, 47,  1),
     sexagesimal3(10, 41,  3),
     sexagesimal3(10, 34, 57),
     sexagesimal3(10, 28, 41),
     sexagesimal3(10, 22, 18),
     sexagesimal3(10, 15, 47),
     sexagesimal3(10,  9,  8),
     sexagesimal3(10,  2, 21),
     sexagesimal3( 9, 55, 26),
     sexagesimal3( 9, 48, 24),
     sexagesimal3( 9, 41, 15),
     sexagesimal3( 9, 33, 58),
     sexagesimal3( 9, 26, 35),
     sexagesimal3( 9, 19,  4),
     sexagesimal3( 9, 11, 27),
     sexagesimal3( 9,  3, 44),
     sexagesimal3( 8, 55, 53),
     sexagesimal3( 8, 47, 57),
     sexagesimal3( 8, 39, 54),
     sexagesimal3( 8, 31, 45),
     sexagesimal3( 8, 23, 31),
     sexagesimal3( 8, 15, 10),
     sexagesimal3( 8,  6, 44),
     sexagesimal3( 7, 58, 13),
     sexagesimal3( 7, 49, 36),
     sexagesimal3( 7, 40, 53),
     sexagesimal3( 7, 32,  6),
     sexagesimal3( 7, 23, 14),
     sexagesimal3( 7, 14, 16),
     sexagesimal3( 7,  5, 14),
     sexagesimal3( 6, 56,  8),
     sexagesimal3( 6, 46, 56),
     sexagesimal3( 6, 37, 41),
     sexagesimal3( 6, 28, 21),
     sexagesimal3( 6, 18, 57),
     sexagesimal3( 6,  9, 29),
     sexagesimal3( 5, 59, 58),
     sexagesimal3( 5, 50, 22),
     sexagesimal3( 5, 40, 43),
     sexagesimal3( 5, 31,  0),
     sexagesimal3( 5, 21, 14),
     sexagesimal3( 5, 11, 24),
     sexagesimal3( 5,  1, 31),
     sexagesimal3( 4, 51, 35),
     sexagesimal3( 4, 41, 37),
     sexagesimal3( 4, 31, 35),
     sexagesimal3( 4, 21, 30),
     sexagesimal3( 4, 11, 22),
     sexagesimal3( 4,  1, 14),
     sexagesimal3( 3, 51,  2),
     sexagesimal3( 3, 40, 47),
     sexagesimal3( 3, 30, 31),
     sexagesimal3( 3, 20, 12),
     sexagesimal3( 3,  9, 51),
     sexagesimal3( 2, 59, 29),
     sexagesimal3( 2, 49,  5),
     sexagesimal3( 2, 38, 39),
     sexagesimal3( 2, 28, 11),
     sexagesimal3( 2, 17, 42),
     sexagesimal3( 2,  7, 12),
     sexagesimal3( 1, 56, 40),
     sexagesimal3( 1, 46,  7),
     sexagesimal3( 1, 35, 33),
     sexagesimal3( 1, 24, 59),
     sexagesimal3( 1, 14, 23),
     sexagesimal3( 1,  3, 47),
     sexagesimal3( 0, 53, 10),
     sexagesimal3( 0, 42, 33),
     sexagesimal3( 0, 31, 55),
     sexagesimal3( 0, 21, 17),
     sexagesimal3( 0, 10, 38),
     sexagesimal3( 0,  0,  0),
    };
  return interpolate_symmetric_linear(sizeof(table)/sizeof(*table),
                                      table, angle);
}

double prutenic_prop_luna(double angle)
{
  double table[] =
    {
     sexagesimal2( 0,  0),
     sexagesimal2( 0,  0),
     sexagesimal2( 0,  1),
     sexagesimal2( 0,  3),
     sexagesimal2( 0,  6),
     sexagesimal2( 0,  9),
     sexagesimal2( 0, 13),
     sexagesimal2( 0, 17),
     sexagesimal2( 0, 22),
     sexagesimal2( 0, 28),
     sexagesimal2( 0, 35),
     sexagesimal2( 0, 42),
     sexagesimal2( 0, 50),
     sexagesimal2( 0, 58),
     sexagesimal2( 1,  8),
     sexagesimal2( 1, 18),
     sexagesimal2( 1, 28),
     sexagesimal2( 1, 39),
     sexagesimal2( 1, 51),
     sexagesimal2( 2,  4),
     sexagesimal2( 2, 17),
     sexagesimal2( 2, 31),
     sexagesimal2( 2, 45),
     sexagesimal2( 3,  0),
     sexagesimal2( 3, 15),
     sexagesimal2( 3, 31),
     sexagesimal2( 3, 48),
     sexagesimal2( 4,  5),
     sexagesimal2( 4, 23),
     sexagesimal2( 4, 41),
     sexagesimal2( 5,  0),
     sexagesimal2( 5, 19),
     sexagesimal2( 5, 39),
     sexagesimal2( 6,  0),
     sexagesimal2( 6, 21),
     sexagesimal2( 6, 42),
     sexagesimal2( 7,  4),
     sexagesimal2( 7, 26),
     sexagesimal2( 7, 49),
     sexagesimal2( 8, 12),
     sexagesimal2( 8, 36),
     sexagesimal2( 9,  0),
     sexagesimal2( 9, 24),
     sexagesimal2( 9, 49),
     sexagesimal2(10, 14),
     sexagesimal2(10, 39),
     sexagesimal2(11,  5),
     sexagesimal2(11, 31),
     sexagesimal2(11, 58),
     sexagesimal2(12, 25),
     sexagesimal2(12, 52),
     sexagesimal2(13, 20),
     sexagesimal2(13, 48),
     sexagesimal2(14, 16),
     sexagesimal2(14, 44),
     sexagesimal2(15, 13),
     sexagesimal2(15, 42),
     sexagesimal2(16, 11),
     sexagesimal2(16, 40),
     sexagesimal2(17, 10),
     sexagesimal2(17, 39),
     sexagesimal2(18,  9),
     sexagesimal2(18, 39),
     sexagesimal2(19, 10),
     sexagesimal2(19, 40),
     sexagesimal2(20, 10),
     sexagesimal2(20, 41),
     sexagesimal2(21, 12),
     sexagesimal2(21, 43),
     sexagesimal2(22, 14),
     sexagesimal2(22, 45),
     sexagesimal2(23, 16),
     sexagesimal2(23, 47),
     sexagesimal2(24, 18),
     sexagesimal2(24, 50),
     sexagesimal2(25, 21),
     sexagesimal2(25, 53),
     sexagesimal2(26, 24),
     sexagesimal2(26, 55),
     sexagesimal2(27, 27),
     sexagesimal2(27, 58),
     sexagesimal2(28, 29),
     sexagesimal2(29,  1),
     sexagesimal2(29, 32),
     sexagesimal2(30,  3),
     sexagesimal2(30, 35),
     sexagesimal2(31,  6),
     sexagesimal2(31, 37),
     sexagesimal2(32,  8),
     sexagesimal2(32, 39),
     sexagesimal2(33,  9),
     sexagesimal2(33, 40),
     sexagesimal2(34, 11),
     sexagesimal2(34, 41),
     sexagesimal2(35, 11),
     sexagesimal2(35, 42),
     sexagesimal2(36, 12),
     sexagesimal2(36, 41),
     sexagesimal2(37, 11),
     sexagesimal2(37, 40),
     sexagesimal2(38, 10),
     sexagesimal2(38, 39),
     sexagesimal2(39,  8),
     sexagesimal2(39, 37),
     sexagesimal2(40,  5),
     sexagesimal2(40, 34),
     sexagesimal2(41,  2),
     sexagesimal2(41, 29),
     sexagesimal2(41, 57),
     sexagesimal2(42, 25),
     sexagesimal2(42, 52),
     sexagesimal2(43, 19),
     sexagesimal2(43, 45),
     sexagesimal2(44, 12),
     sexagesimal2(44, 38),
     sexagesimal2(45,  4),
     sexagesimal2(45, 29),
     sexagesimal2(45, 55),
     sexagesimal2(46, 20),
     sexagesimal2(46, 45),
     sexagesimal2(47,  9),
     sexagesimal2(47, 33),
     sexagesimal2(47, 57),
     sexagesimal2(48, 20),
     sexagesimal2(48, 43),
     sexagesimal2(49,  6),
     sexagesimal2(49, 29),
     sexagesimal2(49, 51),
     sexagesimal2(50, 12),
     sexagesimal2(50, 34),
     sexagesimal2(50, 55),
     sexagesimal2(51, 16),
     sexagesimal2(51, 36),
     sexagesimal2(51, 56),
     sexagesimal2(52, 16),
     sexagesimal2(52, 35),
     sexagesimal2(52, 54),
     sexagesimal2(53, 13),
     sexagesimal2(53, 31),
     sexagesimal2(53, 49),
     sexagesimal2(54,  7),
     sexagesimal2(54, 24),
     sexagesimal2(54, 40),
     sexagesimal2(54, 56),
     sexagesimal2(55, 12),
     sexagesimal2(55, 28),
     sexagesimal2(55, 43),
     sexagesimal2(55, 58),
     sexagesimal2(56, 12),
     sexagesimal2(56, 26),
     sexagesimal2(56, 39),
     sexagesimal2(56, 52),
     sexagesimal2(57,  5),
     sexagesimal2(57, 17),
     sexagesimal2(57, 29),
     sexagesimal2(57, 40),
     sexagesimal2(57, 51),
     sexagesimal2(58,  1),
     sexagesimal2(58, 11),
     sexagesimal2(58, 21),
     sexagesimal2(58, 30),
     sexagesimal2(58, 39),
     sexagesimal2(58, 47),
     sexagesimal2(58, 55),
     sexagesimal2(59,  2),
     sexagesimal2(59,  9),
     sexagesimal2(59, 16),
     sexagesimal2(59, 22),
     sexagesimal2(59, 27),
     sexagesimal2(59, 33),
     sexagesimal2(59, 38),
     sexagesimal2(59, 42),
     sexagesimal2(59, 46),
     sexagesimal2(59, 49),
     sexagesimal2(59, 52),
     sexagesimal2(59, 54),
     sexagesimal2(59, 56),
     sexagesimal2(59, 58),
     sexagesimal2(59, 59),
     sexagesimal2(60,  0),
     sexagesimal2(60,  0),
    };
  return interpolate_symmetric_linear(sizeof(table)/sizeof(*table),
                                      table, angle);
}

double prutenic_1st_epicycle_luna(double angle)
{
  double table[] =
    {
     sexagesimal3( 0,  0,  0),
     sexagesimal3( 0,  4, 45),
     sexagesimal3( 0,  9, 31),
     sexagesimal3( 0, 14, 16),
     sexagesimal3( 0, 19,  1),
     sexagesimal3( 0, 23, 45),
     sexagesimal3( 0, 28, 30),
     sexagesimal3( 0, 33, 14),
     sexagesimal3( 0, 37, 57),
     sexagesimal3( 0, 42, 40),
     sexagesimal3( 0, 47, 22),
     sexagesimal3( 0, 52,  4),
     sexagesimal3( 0, 56, 45),
     sexagesimal3( 1,  1, 25),
     sexagesimal3( 1,  6,  4),
     sexagesimal3( 1, 10, 43),
     sexagesimal3( 1, 15, 20),
     sexagesimal3( 1, 19, 56),
     sexagesimal3( 1, 24, 31),
     sexagesimal3( 1, 29,  5),
     sexagesimal3( 1, 33, 37),
     sexagesimal3( 1, 38,  8),
     sexagesimal3( 1, 42, 38),
     sexagesimal3( 1, 47,  7),
     sexagesimal3( 1, 51, 34),
     sexagesimal3( 1, 55, 59),
     sexagesimal3( 2,  0, 22),
     sexagesimal3( 2,  4, 44),
     sexagesimal3( 2,  9,  4),
     sexagesimal3( 2, 13, 22),
     sexagesimal3( 2, 17, 38),
     sexagesimal3( 2, 21, 52),
     sexagesimal3( 2, 26,  4),
     sexagesimal3( 2, 30, 14),
     sexagesimal3( 2, 34, 22),
     sexagesimal3( 2, 38, 28),
     sexagesimal3( 2, 42, 31),
     sexagesimal3( 2, 46, 31),
     sexagesimal3( 2, 50, 30),
     sexagesimal3( 2, 54, 25),
     sexagesimal3( 2, 58, 18),
     sexagesimal3( 3,  2,  9),
     sexagesimal3( 3,  5, 57),
     sexagesimal3( 3,  9, 42),
     sexagesimal3( 3, 13, 24),
     sexagesimal3( 3, 17,  3),
     sexagesimal3( 3, 20, 39),
     sexagesimal3( 3, 24, 12),
     sexagesimal3( 3, 27, 42),
     sexagesimal3( 3, 31,  9),
     sexagesimal3( 3, 34, 33),
     sexagesimal3( 3, 37, 53),
     sexagesimal3( 3, 41, 10),
     sexagesimal3( 3, 44, 24),
     sexagesimal3( 3, 47, 34),
     sexagesimal3( 3, 50, 41),
     sexagesimal3( 3, 53, 44),
     sexagesimal3( 3, 56, 43),
     sexagesimal3( 3, 59, 39),
     sexagesimal3( 4,  2, 31),
     sexagesimal3( 4,  5, 19),
     sexagesimal3( 4,  8,  3),
     sexagesimal3( 4, 10, 43),
     sexagesimal3( 4, 13, 19),
     sexagesimal3( 4, 15, 51),
     sexagesimal3( 4, 18, 19),
     sexagesimal3( 4, 20, 43),
     sexagesimal3( 4, 23,  3),
     sexagesimal3( 4, 25, 18),
     sexagesimal3( 4, 27, 29),
     sexagesimal3( 4, 29, 36),
     sexagesimal3( 4, 31, 38),
     sexagesimal3( 4, 33, 36),
     sexagesimal3( 4, 35, 29),
     sexagesimal3( 4, 37, 18),
     sexagesimal3( 4, 39,  2),
     sexagesimal3( 4, 40, 41),
     sexagesimal3( 4, 42, 15),
     sexagesimal3( 4, 43, 45),
     sexagesimal3( 4, 45, 10),
     sexagesimal3( 4, 46, 30),
     sexagesimal3( 4, 47, 45),
     sexagesimal3( 4, 48, 55),
     sexagesimal3( 4, 50,  1),
     sexagesimal3( 4, 51,  1),
     sexagesimal3( 4, 51, 56),
     sexagesimal3( 4, 52, 46),
     sexagesimal3( 4, 53, 31),
     sexagesimal3( 4, 54, 10),
     sexagesimal3( 4, 54, 45),
     sexagesimal3( 4, 55, 14),
     sexagesimal3( 4, 55, 38),
     sexagesimal3( 4, 55, 56),
     sexagesimal3( 4, 56,  9),
     sexagesimal3( 4, 56, 17),
     sexagesimal3( 4, 56, 19),
     sexagesimal3( 4, 56, 16),
     sexagesimal3( 4, 56,  8),
     sexagesimal3( 4, 55, 54),
     sexagesimal3( 4, 55, 34),
     sexagesimal3( 4, 55,  9),
     sexagesimal3( 4, 54, 39),
     sexagesimal3( 4, 54,  3),
     sexagesimal3( 4, 53, 21),
     sexagesimal3( 4, 52, 34),
     sexagesimal3( 4, 51, 41),
     sexagesimal3( 4, 50, 43),
     sexagesimal3( 4, 49, 39),
     sexagesimal3( 4, 48, 29),
     sexagesimal3( 4, 47, 14),
     sexagesimal3( 4, 45, 53),
     sexagesimal3( 4, 44, 27),
     sexagesimal3( 4, 42, 55),
     sexagesimal3( 4, 41, 17),
     sexagesimal3( 4, 39, 34),
     sexagesimal3( 4, 37, 45),
     sexagesimal3( 4, 35, 51),
     sexagesimal3( 4, 33, 51),
     sexagesimal3( 4, 31, 45),
     sexagesimal3( 4, 29, 34),
     sexagesimal3( 4, 27, 18),
     sexagesimal3( 4, 24, 56),
     sexagesimal3( 4, 22, 28),
     sexagesimal3( 4, 19, 55),
     sexagesimal3( 4, 17, 17),
     sexagesimal3( 4, 14, 34),
     sexagesimal3( 4, 11, 45),
     sexagesimal3( 4,  8, 50),
     sexagesimal3( 4,  5, 51),
     sexagesimal3( 4,  2, 46),
     sexagesimal3( 3, 59, 36),
     sexagesimal3( 3, 56, 21),
     sexagesimal3( 3, 53,  1),
     sexagesimal3( 3, 49, 36),
     sexagesimal3( 3, 46,  6),
     sexagesimal3( 3, 42, 32),
     sexagesimal3( 3, 38, 52),
     sexagesimal3( 3, 35,  7),
     sexagesimal3( 3, 31, 18),
     sexagesimal3( 3, 27, 24),
     sexagesimal3( 3, 23, 26),
     sexagesimal3( 3, 19, 23),
     sexagesimal3( 3, 15, 16),
     sexagesimal3( 3, 11,  4),
     sexagesimal3( 3,  6, 48),
     sexagesimal3( 3,  2, 28),
     sexagesimal3( 2, 58,  3),
     sexagesimal3( 2, 53, 35),
     sexagesimal3( 2, 49,  3),
     sexagesimal3( 2, 44, 27),
     sexagesimal3( 2, 39, 47),
     sexagesimal3( 2, 35,  4),
     sexagesimal3( 2, 30, 17),
     sexagesimal3( 2, 25, 26),
     sexagesimal3( 2, 20, 32),
     sexagesimal3( 2, 15, 35),
     sexagesimal3( 2, 10, 35),
     sexagesimal3( 2,  5, 32),
     sexagesimal3( 2,  0, 26),
     sexagesimal3( 1, 55, 17),
     sexagesimal3( 1, 50,  6),
     sexagesimal3( 1, 44, 52),
     sexagesimal3( 1, 39, 35),
     sexagesimal3( 1, 34, 16),
     sexagesimal3( 1, 28, 55),
     sexagesimal3( 1, 23, 32),
     sexagesimal3( 1, 18,  7),
     sexagesimal3( 1, 12, 40),
     sexagesimal3( 1,  7, 11),
     sexagesimal3( 1,  1, 41),
     sexagesimal3( 0, 56,  9),
     sexagesimal3( 0, 50, 36),
     sexagesimal3( 0, 45,  2),
     sexagesimal3( 0, 39, 26),
     sexagesimal3( 0, 33, 50),
     sexagesimal3( 0, 28, 13),
     sexagesimal3( 0, 22, 35),
     sexagesimal3( 0, 16, 57),
     sexagesimal3( 0, 11, 18),
     sexagesimal3( 0,  5, 39),
     sexagesimal3( 0,  0,  0),
    };
  return interpolate_symmetric_linear(sizeof(table)/sizeof(*table),
                                      table, angle);
}

double prutenic_excess_luna(double angle)
{
  double table[] =
    {
     sexagesimal3( 0,  0,  0),
     sexagesimal3( 0,  2, 18),
     sexagesimal3( 0,  4, 37),
     sexagesimal3( 0,  6, 55),
     sexagesimal3( 0,  9, 13),
     sexagesimal3( 0, 11, 32),
     sexagesimal3( 0, 13, 50),
     sexagesimal3( 0, 16,  8),
     sexagesimal3( 0, 18, 25),
     sexagesimal3( 0, 20, 43),
     sexagesimal3( 0, 23,  0),
     sexagesimal3( 0, 25, 17),
     sexagesimal3( 0, 27, 35),
     sexagesimal3( 0, 29, 52),
     sexagesimal3( 0, 32,  8),
     sexagesimal3( 0, 34, 25),
     sexagesimal3( 0, 36, 41),
     sexagesimal3( 0, 38, 56),
     sexagesimal3( 0, 41, 12),
     sexagesimal3( 0, 43, 27),
     sexagesimal3( 0, 45, 41),
     sexagesimal3( 0, 47, 55),
     sexagesimal3( 0, 50,  9),
     sexagesimal3( 0, 52, 22),
     sexagesimal3( 0, 54, 35),
     sexagesimal3( 0, 56, 48),
     sexagesimal3( 0, 58, 59),
     sexagesimal3( 1,  1, 11),
     sexagesimal3( 1,  3, 21),
     sexagesimal3( 1,  5, 31),
     sexagesimal3( 1,  7, 41),
     sexagesimal3( 1,  9, 50),
     sexagesimal3( 1, 11, 58),
     sexagesimal3( 1, 14,  6),
     sexagesimal3( 1, 16, 12),
     sexagesimal3( 1, 18, 18),
     sexagesimal3( 1, 20, 24),
     sexagesimal3( 1, 22, 28),
     sexagesimal3( 1, 24, 32),
     sexagesimal3( 1, 26, 35),
     sexagesimal3( 1, 28, 37),
     sexagesimal3( 1, 30, 39),
     sexagesimal3( 1, 32, 39),
     sexagesimal3( 1, 34, 38),
     sexagesimal3( 1, 36, 37),
     sexagesimal3( 1, 38, 34),
     sexagesimal3( 1, 40, 30),
     sexagesimal3( 1, 42, 26),
     sexagesimal3( 1, 44, 20),
     sexagesimal3( 1, 46, 13),
     sexagesimal3( 1, 48,  5),
     sexagesimal3( 1, 49, 56),
     sexagesimal3( 1, 51, 45),
     sexagesimal3( 1, 53, 34),
     sexagesimal3( 1, 55, 21),
     sexagesimal3( 1, 57,  7),
     sexagesimal3( 1, 58, 51),
     sexagesimal3( 2,  0, 34),
     sexagesimal3( 2,  2, 16),
     sexagesimal3( 2,  3, 57),
     sexagesimal3( 2,  5, 35),
     sexagesimal3( 2,  7, 13),
     sexagesimal3( 2,  8, 49),
     sexagesimal3( 2, 10, 23),
     sexagesimal3( 2, 11, 56),
     sexagesimal3( 2, 13, 27),
     sexagesimal3( 2, 14, 56),
     sexagesimal3( 2, 16, 24),
     sexagesimal3( 2, 17, 50),
     sexagesimal3( 2, 19, 14),
     sexagesimal3( 2, 20, 36),
     sexagesimal3( 2, 21, 57),
     sexagesimal3( 2, 23, 16),
     sexagesimal3( 2, 24, 32),
     sexagesimal3( 2, 25, 47),
     sexagesimal3( 2, 27,  0),
     sexagesimal3( 2, 28, 10),
     sexagesimal3( 2, 29, 19),
     sexagesimal3( 2, 30, 25),
     sexagesimal3( 2, 31, 30),
     sexagesimal3( 2, 32, 32),
     sexagesimal3( 2, 33, 32),
     sexagesimal3( 2, 34, 29),
     sexagesimal3( 2, 35, 24),
     sexagesimal3( 2, 36, 17),
     sexagesimal3( 2, 37,  8),
     sexagesimal3( 2, 37, 56),
     sexagesimal3( 2, 38, 41),
     sexagesimal3( 2, 39, 24),
     sexagesimal3( 2, 40,  5),
     sexagesimal3( 2, 40, 42),
     sexagesimal3( 2, 41, 17),
     sexagesimal3( 2, 41, 50),
     sexagesimal3( 2, 42, 20),
     sexagesimal3( 2, 42, 47),
     sexagesimal3( 2, 43, 11),
     sexagesimal3( 2, 43, 32),
     sexagesimal3( 2, 43, 50),
     sexagesimal3( 2, 44,  6),
     sexagesimal3( 2, 44, 18),
     sexagesimal3( 2, 44, 27),
     sexagesimal3( 2, 44, 34),
     sexagesimal3( 2, 44, 37),
     sexagesimal3( 2, 44, 37),
     sexagesimal3( 2, 44, 34),
     sexagesimal3( 2, 44, 28),
     sexagesimal3( 2, 44, 18),
     sexagesimal3( 2, 44,  5),
     sexagesimal3( 2, 43, 49),
     sexagesimal3( 2, 43, 30),
     sexagesimal3( 2, 43,  7),
     sexagesimal3( 2, 42, 41),
     sexagesimal3( 2, 42, 11),
     sexagesimal3( 2, 41, 38),
     sexagesimal3( 2, 41,  2),
     sexagesimal3( 2, 40, 22),
     sexagesimal3( 2, 39, 38),
     sexagesimal3( 2, 38, 51),
     sexagesimal3( 2, 38,  0),
     sexagesimal3( 2, 37,  5),
     sexagesimal3( 2, 36,  7),
     sexagesimal3( 2, 35,  6),
     sexagesimal3( 2, 34,  0),
     sexagesimal3( 2, 32, 51),
     sexagesimal3( 2, 31, 39),
     sexagesimal3( 2, 30, 22),
     sexagesimal3( 2, 29,  2),
     sexagesimal3( 2, 27, 39),
     sexagesimal3( 2, 26, 11),
     sexagesimal3( 2, 24, 40),
     sexagesimal3( 2, 23,  5),
     sexagesimal3( 2, 21, 27),
     sexagesimal3( 2, 19, 45),
     sexagesimal3( 2, 17, 59),
     sexagesimal3( 2, 16,  9),
     sexagesimal3( 2, 14, 16),
     sexagesimal3( 2, 12, 19),
     sexagesimal3( 2, 10, 19),
     sexagesimal3( 2,  8, 15),
     sexagesimal3( 2,  6,  7),
     sexagesimal3( 2,  3, 56),
     sexagesimal3( 2,  1, 41),
     sexagesimal3( 1, 59, 23),
     sexagesimal3( 1, 57,  2),
     sexagesimal3( 1, 54, 37),
     sexagesimal3( 1, 52,  9),
     sexagesimal3( 1, 49, 38),
     sexagesimal3( 1, 47,  3),
     sexagesimal3( 1, 44, 25),
     sexagesimal3( 1, 41, 44),
     sexagesimal3( 1, 39,  0),
     sexagesimal3( 1, 36, 12),
     sexagesimal3( 1, 33, 22),
     sexagesimal3( 1, 30, 30),
     sexagesimal3( 1, 27, 34),
     sexagesimal3( 1, 24, 35),
     sexagesimal3( 1, 21, 34),
     sexagesimal3( 1, 18, 31),
     sexagesimal3( 1, 15, 25),
     sexagesimal3( 1, 12, 16),
     sexagesimal3( 1,  9,  5),
     sexagesimal3( 1,  5, 52),
     sexagesimal3( 1,  2, 37),
     sexagesimal3( 0, 59, 20),
     sexagesimal3( 0, 56,  1),
     sexagesimal3( 0, 52, 40),
     sexagesimal3( 0, 49, 17),
     sexagesimal3( 0, 45, 53),
     sexagesimal3( 0, 42, 27),
     sexagesimal3( 0, 38, 59),
     sexagesimal3( 0, 35, 31),
     sexagesimal3( 0, 32,  1),
     sexagesimal3( 0, 28, 30),
     sexagesimal3( 0, 24, 59),
     sexagesimal3( 0, 21, 26),
     sexagesimal3( 0, 17, 53),
     sexagesimal3( 0, 14, 19),
     sexagesimal3( 0, 10, 45),
     sexagesimal3( 0,  7, 10),
     sexagesimal3( 0,  3, 35),
     sexagesimal3( 0,  0,  0),
    };
  return interpolate_symmetric_linear(sizeof(table)/sizeof(*table),
                                      table, angle);
}

double prutenic_longitude_luna(double days_since_epoch)
{
  static double med_elong_radix = sexagesimal5(209, 58, 22, 36, 56);
  static double med_elong_daily = sexagesimal8(12, 11, 26, 41, 29, 57, 49, 37);

  static double anomaly_radix = sexagesimal5(207, 13, 27, 41, 16);
  static double anomaly_daily = sexagesimal8(13, 3, 53, 56, 23, 57, 40, 46);

  static double arg_latitude_radix = sexagesimal5(129, 41, 50, 37, 59);
  static double arg_latitude_daily
    = sexagesimal8(13, 13, 45, 39, 30, 46, 28, 53);

  double med_elong
    = pmod(med_elong_radix + days_since_epoch*med_elong_daily, 360);
  double anomaly = pmod(anomaly_radix + days_since_epoch*anomaly_daily, 360);
  double arg_latitude
    = pmod(arg_latitude_radix + days_since_epoch*arg_latitude_daily, 360);

  double double_elong = pmod(2*med_elong, 360);
  double epicycle_2 = prutenic_2nd_epicycle_luna(double_elong);
  double corrected_anomaly = pmod((double_elong > 180)?
                                  anomaly - epicycle_2:
                                  anomaly + epicycle_2, 360);
  double prop = prutenic_prop_luna(double_elong);
  double epicycle_1 = prutenic_1st_epicycle_luna(corrected_anomaly);
  double excess = prutenic_excess_luna(corrected_anomaly);

  double corr_add_sub = epicycle_1 + excess*prop/60;

  double elongation = pmod((corrected_anomaly > 180)?
                           med_elong + corr_add_sub:
                           med_elong - corr_add_sub, 360); /* from mean sun */

  double mean_longitude_sol = prutenic_mean_longitude_sol(days_since_epoch);
  double true_longitude_1st_aries = pmod(elongation + mean_longitude_sol, 360);
  double precession = prutenic_precession(days_since_epoch);
  double true_longitude = pmod(true_longitude_1st_aries + precession, 360);
  return true_longitude;
}

static double prutenic_epoch_JD = 1721423.5;

double prutenic_nearest_new_moon(double JD)
{
  double t1, t2, t3;
  double y1, y2, y3;
  int done;

  t1 = JD - prutenic_epoch_JD;
  y1 = smod(prutenic_longitude_sol(t1) - prutenic_longitude_luna(t1), 360);
  if (y1 > 0)
    t2 = t1 + y1/12.19;
  else
    t2 = t1 - y1/12.19;
  y2 = smod(prutenic_longitude_sol(t2) - prutenic_longitude_luna(t2), 360);

  do {
    t3 = (y2*t1 - y1*t2)/(y2 - y1);
    y3 = smod(prutenic_longitude_sol(t3) - prutenic_longitude_luna(t3), 360);
    if (y1*y3 > 0) {
      done = (fabs(y3) >= fabs(y1));
      t1 = t3;
      y1 = y3;
    } else {
      done = (fabs(y3) >= fabs(y2));
      t2 = t3;
      y2 = y3;
    }
  } while (!done);
  return t3 + prutenic_epoch_JD;;
}
